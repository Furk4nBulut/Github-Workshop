name: C# Homework Tests

on:
  pull_request_target:
    paths:
      - 'homeworks/csharp-fundamentals/**/submissions/**'
    types: [opened, synchronize, reopened]
  # Manuel tetikleme ve zamanlÄ± Ã§alÄ±ÅŸtÄ±rma
  workflow_dispatch:
  schedule:
    # Her gÃ¼n saat 00:00 UTC'de Ã§alÄ±ÅŸ
    - cron: '0 0 * * *'

permissions:
  contents: write
  pull-requests: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # PR bazlÄ± test job'u
  test-pr:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    name: Test PR Submissions

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Find Changed Files
        id: changed-files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA -- 'homeworks/csharp-fundamentals/**/submissions/*.cs' 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "any_changed=false" >> $GITHUB_OUTPUT
          else
            echo "any_changed=true" >> $GITHUB_OUTPUT
            echo "all_changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Validate and Test
        id: run-tests
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ðŸ§ª Testler BaÅŸlÄ±yor"
          
          ALL_PASSED=true
          TOTAL_SCORE=0
          
          echo "## ðŸ“Š C# Ã–dev Test SonuÃ§larÄ±" > /tmp/comment_body.md
          echo "" >> /tmp/comment_body.md
          echo "| Problem | Puan | Durum |" >> /tmp/comment_body.md
          echo "|---------|------|-------|" >> /tmp/comment_body.md
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            filename=$(basename "$file")
            
            # Format kontrolÃ¼
            if [[ ! $filename =~ ^Problem[1-4]_[0-9]{9}\.cs$ ]]; then
              echo "âŒ YanlÄ±ÅŸ format: $filename"
              continue
            fi
            
            if [[ "$file" =~ problem-([1-4])/submissions/ ]]; then
              problem_num="${BASH_REMATCH[1]}"
              PROBLEM_DIR="homeworks/csharp-fundamentals/problem-${problem_num}"
              
              echo "Testing: $filename"
              
              TEMP_DIR=$(mktemp -d)
              cp "$file" "$TEMP_DIR/Problem${problem_num}.cs"
              cp "$PROBLEM_DIR/Problem${problem_num}.Tests.cs" "$TEMP_DIR/"
              
              cd "$TEMP_DIR"
              dotnet new console -n TestProject -o . --force > /dev/null 2>&1
              
              set +e
              TEST_OUTPUT=$(dotnet run -- "$filename" 2>&1)
              TEST_EXIT_CODE=$?
              set -e
              
              echo "$TEST_OUTPUT"
              
              SCORE=$(echo "$TEST_OUTPUT" | grep -oP 'TOPLAM PUAN\s*â”‚\s*\K[\d.]+' | head -1 || echo "0")
              [ -z "$SCORE" ] && SCORE="0"
              
              if [ "$TEST_EXIT_CODE" -eq 0 ]; then
                STATUS="âœ… GeÃ§ti"
              else
                STATUS="âŒ KaldÄ±"
                ALL_PASSED=false
              fi
              
              echo "| Problem ${problem_num} | ${SCORE}/25 | ${STATUS} |" >> /tmp/comment_body.md
              TOTAL_SCORE=$(echo "$TOTAL_SCORE + $SCORE" | bc)
              
              cd - > /dev/null
              rm -rf "$TEMP_DIR"
            fi
          done <<< "${{ steps.changed-files.outputs.all_changed_files }}"
          
          echo "" >> /tmp/comment_body.md
          echo "**Toplam Puan:** $TOTAL_SCORE / 100" >> /tmp/comment_body.md
          
          if [ "$ALL_PASSED" = true ]; then
            echo "" >> /tmp/comment_body.md
            echo "ðŸŽ‰ **Tebrikler!** PR merge edilebilir." >> /tmp/comment_body.md
          else
            echo "" >> /tmp/comment_body.md
            echo "âŒ **Testler baÅŸarÄ±sÄ±z.** DÃ¼zeltip tekrar gÃ¶nderin." >> /tmp/comment_body.md
          fi
          
          echo "" >> /tmp/comment_body.md
          echo "---" >> /tmp/comment_body.md
          echo "*GitHub Workshop Bot* ðŸ¤–" >> /tmp/comment_body.md
          
          echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT
          echo "all_passed=$ALL_PASSED" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## âŒ Test Ã§alÄ±ÅŸtÄ±rÄ±lamadÄ±\n\nDetaylar iÃ§in workflow loglarÄ±nÄ± inceleyin.';
            try {
              body = fs.readFileSync('/tmp/comment_body.md', 'utf8');
            } catch (e) {}
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Final Status
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          if [ "${{ steps.run-tests.outputs.all_passed }}" != "true" ]; then
            exit 1
          fi

  # Ä°statistik gÃ¼ncelleme job'u - Manuel veya zamanlÄ±
  update-stats:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    name: Update Statistics
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Scan and Test All Submissions
        run: |
          echo "ðŸ“Š TÃ¼m Ã¶devler taranÄ±yor..."
          
          # SonuÃ§ dosyasÄ±nÄ± baÅŸlat
          echo '{"students":{}}' > /tmp/all_scores.json
          
          # Her problem iÃ§in submissions klasÃ¶rÃ¼nÃ¼ tara
          for problem_num in 1 2 3 4; do
            SUBMISSIONS_DIR="homeworks/csharp-fundamentals/problem-${problem_num}/submissions"
            PROBLEM_DIR="homeworks/csharp-fundamentals/problem-${problem_num}"
            
            echo "ðŸ“ Problem $problem_num taranÄ±yor..."
            
            for file in "$SUBMISSIONS_DIR"/Problem${problem_num}_*.cs; do
              [ -f "$file" ] || continue
              
              filename=$(basename "$file")
              
              # Ã–ÄŸrenci numarasÄ±nÄ± Ã§Ä±kar
              if [[ $filename =~ ^Problem[1-4]_([0-9]{9})\.cs$ ]]; then
                STUDENT_NO="${BASH_REMATCH[1]}"
                
                echo "  Testing: $filename (Student: $STUDENT_NO)"
                
                # Test Ã§alÄ±ÅŸtÄ±r
                TEMP_DIR=$(mktemp -d)
                cp "$file" "$TEMP_DIR/Problem${problem_num}.cs"
                cp "$PROBLEM_DIR/Problem${problem_num}.Tests.cs" "$TEMP_DIR/"
                
                cd "$TEMP_DIR"
                dotnet new console -n TestProject -o . --force > /dev/null 2>&1
                
                set +e
                TEST_OUTPUT=$(dotnet run -- "$filename" 2>&1)
                set -e
                
                # PuanÄ± Ã§Ä±kar
                SCORE=$(echo "$TEST_OUTPUT" | grep -oP 'TOPLAM PUAN\s*â”‚\s*\K[\d.]+' | head -1 || echo "0")
                [ -z "$SCORE" ] && SCORE="0"
                
                echo "    Score: $SCORE/25"
                
                # JSON'a ekle
                jq --arg sno "$STUDENT_NO" --arg pnum "problem$problem_num" --arg score "$SCORE" '
                  .students[$sno] //= {"problem1":0,"problem2":0,"problem3":0,"problem4":0} |
                  .students[$sno][$pnum] = ($score | tonumber)
                ' /tmp/all_scores.json > /tmp/temp.json && mv /tmp/temp.json /tmp/all_scores.json
                
                cd - > /dev/null
                rm -rf "$TEMP_DIR"
              fi
            done
          done
          
          echo ""
          echo "âœ… Tarama tamamlandÄ±"
          cat /tmp/all_scores.json

      - name: Generate Final Scores JSON
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Ã–ÄŸrenci listesini oluÅŸtur
          STUDENTS_ARRAY=$(jq -r '
            [.students | to_entries[] | {
              studentNo: .key,
              scores: .value,
              total: ((.value.problem1 // 0) + (.value.problem2 // 0) + (.value.problem3 // 0) + (.value.problem4 // 0)),
              lastSubmission: "'"$TIMESTAMP"'"
            }] | sort_by(-.total)
          ' /tmp/all_scores.json)
          
          # Ä°statistikleri hesapla
          TOTAL_STUDENTS=$(echo "$STUDENTS_ARRAY" | jq 'length')
          
          if [ "$TOTAL_STUDENTS" -gt 0 ]; then
            AVG_SCORE=$(echo "$STUDENTS_ARRAY" | jq '[.[].total] | add / length')
            HIGHEST=$(echo "$STUDENTS_ARRAY" | jq '[.[].total] | max')
            TOTAL_SUBS=$(echo "$STUDENTS_ARRAY" | jq '[.[].total | select(. > 0)] | length')
            
            # Problem bazlÄ± istatistikler
            P1_ATTEMPTS=$(echo "$STUDENTS_ARRAY" | jq '[.[].scores.problem1 | select(. > 0)] | length')
            P1_AVG=$(echo "$STUDENTS_ARRAY" | jq 'if ([.[].scores.problem1 | select(. > 0)] | length) > 0 then [.[].scores.problem1 | select(. > 0)] | add / length else 0 end')
            P1_PASS=$(echo "$STUDENTS_ARRAY" | jq '[.[].scores.problem1 | select(. == 25)] | length')
            P1_RATE=$(echo "scale=0; ($P1_PASS * 100) / ($P1_ATTEMPTS + 1)" | bc 2>/dev/null || echo "0")
            
            P2_ATTEMPTS=$(echo "$STUDENTS_ARRAY" | jq '[.[].scores.problem2 | select(. > 0)] | length')
            P2_AVG=$(echo "$STUDENTS_ARRAY" | jq 'if ([.[].scores.problem2 | select(. > 0)] | length) > 0 then [.[].scores.problem2 | select(. > 0)] | add / length else 0 end')
            P2_PASS=$(echo "$STUDENTS_ARRAY" | jq '[.[].scores.problem2 | select(. == 25)] | length')
            P2_RATE=$(echo "scale=0; ($P2_PASS * 100) / ($P2_ATTEMPTS + 1)" | bc 2>/dev/null || echo "0")
            
            P3_ATTEMPTS=$(echo "$STUDENTS_ARRAY" | jq '[.[].scores.problem3 | select(. > 0)] | length')
            P3_AVG=$(echo "$STUDENTS_ARRAY" | jq 'if ([.[].scores.problem3 | select(. > 0)] | length) > 0 then [.[].scores.problem3 | select(. > 0)] | add / length else 0 end')
            P3_PASS=$(echo "$STUDENTS_ARRAY" | jq '[.[].scores.problem3 | select(. == 25)] | length')
            P3_RATE=$(echo "scale=0; ($P3_PASS * 100) / ($P3_ATTEMPTS + 1)" | bc 2>/dev/null || echo "0")
            
            P4_ATTEMPTS=$(echo "$STUDENTS_ARRAY" | jq '[.[].scores.problem4 | select(. > 0)] | length')
            P4_AVG=$(echo "$STUDENTS_ARRAY" | jq 'if ([.[].scores.problem4 | select(. > 0)] | length) > 0 then [.[].scores.problem4 | select(. > 0)] | add / length else 0 end')
            P4_PASS=$(echo "$STUDENTS_ARRAY" | jq '[.[].scores.problem4 | select(. == 25)] | length')
            P4_RATE=$(echo "scale=0; ($P4_PASS * 100) / ($P4_ATTEMPTS + 1)" | bc 2>/dev/null || echo "0")
          else
            AVG_SCORE=0
            HIGHEST=0
            TOTAL_SUBS=0
            P1_ATTEMPTS=0; P1_AVG=0; P1_RATE=0
            P2_ATTEMPTS=0; P2_AVG=0; P2_RATE=0
            P3_ATTEMPTS=0; P3_AVG=0; P3_RATE=0
            P4_ATTEMPTS=0; P4_AVG=0; P4_RATE=0
          fi
          
          # Final JSON oluÅŸtur
          cat > docs/data/scores.json << EOF
          {
            "lastUpdated": "$TIMESTAMP",
            "statistics": {
              "totalStudents": $TOTAL_STUDENTS,
              "totalSubmissions": $TOTAL_SUBS,
              "averageScore": $AVG_SCORE,
              "highestScore": $HIGHEST,
              "problemStats": {
                "problem1": { "attempts": $P1_ATTEMPTS, "avgScore": $P1_AVG, "passRate": $P1_RATE },
                "problem2": { "attempts": $P2_ATTEMPTS, "avgScore": $P2_AVG, "passRate": $P2_RATE },
                "problem3": { "attempts": $P3_ATTEMPTS, "avgScore": $P3_AVG, "passRate": $P3_RATE },
                "problem4": { "attempts": $P4_ATTEMPTS, "avgScore": $P4_AVG, "passRate": $P4_RATE }
              }
            },
            "students": $STUDENTS_ARRAY
          }
          EOF
          
          # JSON formatla
          jq '.' docs/data/scores.json > /tmp/formatted.json && mv /tmp/formatted.json docs/data/scores.json
          
          echo ""
          echo "ðŸ“Š Final scores.json:"
          cat docs/data/scores.json

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/data/scores.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update student statistics [skip ci]"
            git push
            echo "âœ… Scores updated and pushed!"
          fi
